<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vinyl Reverse Player</title>
    <style>
        body { background: #111; color: white; text-align: center; font-family: sans-serif; }
        #disk {
            transition: transform 0.05s linear;
            position: relative;
            margin: 50px auto;
            width: 300px; height: 300px;
            border: 8px solid white;
            border-radius: 50%;
            background: radial-gradient(#555, #222);
            overflow: hidden;
        }
        .label {
            position: absolute;
            top: 50%; left: 50%;
            width: 40px; height: 40px;
            background: #ff5555;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .marker {
            position: absolute;
            top: 0; left: 50%;
            width: 4px; height: 20px;
            background: white;
            transform: translateX(-50%);
            z-index: 1;
        }
        .controls {
            margin: 20px auto;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .controls button {
            padding: 10px 20px;
            font-size: 16px;
        }
        #rateSliderContainer {
            margin: 20px auto;
            width: 300px;
        }
        .upload-container {
            margin: 20px auto;
        }
    </style>
</head>
<body>
<h1>üåÄ Vinyl Reverse Player</h1>

<div class="upload-container">
    <input type="file" id="audioFile" accept="audio/*">
</div>

<div id="disk">
    <svg id="progressTrack" width="300" height="300" viewBox="0 0 300 300" style="position: absolute; top: 0; left: 0; pointer-events: none;">
        <circle cx="150" cy="150" r="140" stroke="lime" stroke-width="4" fill="none" stroke-dasharray="879" stroke-dashoffset="879"/>
    </svg>
    <div class="label"></div>
    <div class="marker"></div>
</div>

<div id="rateSliderContainer">
    <input id="rateSlider" type="range" min="-3" max="3" step="0.1" value="1" style="width: 100%;">
    <div>Rate: <span id="rateValue">1</span></div>
    <input id="seekSlider" type="range" min="0" max="1" step="0.001" value="0" style="width: 100%;">
</div>

<div class="controls">
    <button id="holdBack">‚è™</button>
    <button id="holdForward">‚è©</button>
    <button id="playPause">‚èØÔ∏è</button>
</div>

<script>
    let context, originalBuffer, reversedBuffer, forwardSource, reverseSource, forwardGain, reverseGain;
    let basePosition = 0, startTime = 0, currentRate = 1, angle = 0, lastNonZeroRate = 1;
    let holdInterval = null;

    const disk = document.getElementById('disk');
    const rateSlider = document.getElementById('rateSlider');
    const rateValue = document.getElementById('rateValue');
    const seekSlider = document.getElementById('seekSlider');
    const audioFileInput = document.getElementById('audioFile');

    async function createContext() {
        context = new (window.AudioContext || window.webkitAudioContext)();
        if (context.state === 'suspended') await context.resume();
    }

    async function loadBuffers(file) {
        const arrayBuffer = await file.arrayBuffer();
        originalBuffer = await context.decodeAudioData(arrayBuffer);
        reversedBuffer = context.createBuffer(originalBuffer.numberOfChannels, originalBuffer.length, originalBuffer.sampleRate);
        for (let i = 0; i < originalBuffer.numberOfChannels; i++) {
            const data = originalBuffer.getChannelData(i);
            const rev = reversedBuffer.getChannelData(i);
            for (let j = 0; j < data.length; j++) rev[j] = data[data.length - j - 1];
        }
    }

    function stopSources() {
        try { forwardSource?.stop(); } catch (e) {}
        try { reverseSource?.stop(); } catch (e) {}
        forwardSource?.disconnect(); reverseSource?.disconnect();
    }

    function startSources(position) {
        stopSources();
        forwardSource = context.createBufferSource();
        reverseSource = context.createBufferSource();
        forwardGain = context.createGain();
        reverseGain = context.createGain();

        forwardSource.buffer = originalBuffer;
        reverseSource.buffer = reversedBuffer;
        forwardSource.loop = reverseSource.loop = true;

        forwardSource.connect(forwardGain).connect(context.destination);
        reverseSource.connect(reverseGain).connect(context.destination);

        forwardSource.start(0, position);
        reverseSource.start(0, reversedBuffer.duration - position); // üõ†Ô∏è –§–Ü–ö–°: –∑–∞–ø—É—Å–∫ —ñ–∑ –¥–∑–µ—Ä–∫–∞–ª—å–Ω–æ—ó –ø–æ–∑–∏—Ü—ñ—ó

        forwardSource.playbackRate.value = Math.abs(currentRate);
        reverseSource.playbackRate.value = Math.abs(currentRate);

        startTime = context.currentTime;
        basePosition = position;
    }

    function applyRateChange(newRate) {
        const now = context.currentTime;
        const elapsed = now - startTime;

        // –Ø–∫—â–æ –º–∏ –±—É–ª–∏ –≤ —Ä–µ–≤–µ—Ä—Å—ñ ‚Äî –ø–æ–∑–∏—Ü—ñ—è –∑–º–µ–Ω—à—É—î—Ç—å—Å—è
        basePosition = (basePosition + elapsed * currentRate + originalBuffer.duration) % originalBuffer.duration;

        // –ü–µ—Ä–µ–¥ –∑–º—ñ–Ω–æ—é rate ‚Äî –¥–∑–µ—Ä–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ basePosition, —è–∫—â–æ –º—ñ–Ω—è—î–º–æ –Ω–∞–ø—Ä—è–º
        if (Math.sign(currentRate) !== Math.sign(newRate)) {
            basePosition = originalBuffer.duration - basePosition;
        }

        currentRate = newRate;
        startTime = now;
    }

    function smoothSetRate(targetRate, duration = 300) {
        const steps = 30;
        const interval = duration / steps;
        let step = 0;
        const startRate = currentRate;

        applyRateChange(currentRate);

        clearInterval(holdInterval);
        holdInterval = setInterval(() => {
            step++;
            const t = step / steps;
            currentRate = startRate * (1 - t) + targetRate * t;
            rateSlider.value = currentRate.toFixed(2);
            rateValue.textContent = currentRate.toFixed(2);
            if (step >= steps) {
                clearInterval(holdInterval);
                currentRate = targetRate;
            }
        }, interval);
    }

    function updateUI() {
        if (!context || !originalBuffer || context.state !== 'running') return;

        const now = context.currentTime;
        const elapsed = now - startTime;
        basePosition = (basePosition + elapsed * currentRate + originalBuffer.duration) % originalBuffer.duration;
        startTime = now;

        if (forwardSource) forwardSource.playbackRate.value = Math.abs(currentRate);
        if (reverseSource) reverseSource.playbackRate.value = Math.abs(currentRate);
        if (forwardGain) forwardGain.gain.value = currentRate > 0 ? 1 : 0;
        if (reverseGain) reverseGain.gain.value = currentRate < 0 ? 1 : 0;

        seekSlider.value = (basePosition / originalBuffer.duration).toFixed(3);
        const circle = document.querySelector('#progressTrack circle');
        circle.setAttribute('stroke-dashoffset', 879 * (1 - basePosition / originalBuffer.duration));

        angle += currentRate * 2.5;
        disk.style.transform = `rotate(${angle}deg)`;
    }

    function setState(rate) {
        const oldRate = currentRate;
        applyRateChange(rate);

        console.log(basePosition);
        if (Math.sign(oldRate) !== Math.sign(rate)) {
            basePosition = originalBuffer.duration - basePosition;
        }

        startSources(basePosition);

        if (forwardGain) forwardGain.gain.value = rate > 0 ? 1 : 0;
        if (reverseGain) reverseGain.gain.value = rate < 0 ? 1 : 0;
    }

    document.addEventListener('click', async () => {
        document.getElementById('tapToStart')?.remove();
        if (!context) {
            await createContext();
        }
    }, { once: true });

    audioFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('audio')) {
            await loadBuffers(file);
            setState(0);
        }
    });

    rateSlider.addEventListener('input', () => {
        smoothSetRate(parseFloat(rateSlider.value));
    });

    seekSlider.addEventListener('input', (e) => {
        basePosition = parseFloat(e.target.value) * originalBuffer.duration;
        startSources(basePosition);
    });

    document.getElementById('holdBack').addEventListener('mousedown', () => smoothSetRate(-1));
    document.getElementById('holdForward').addEventListener('mousedown', () => smoothSetRate(1));
    document.getElementById('holdBack').addEventListener('mouseup', () => clearInterval(holdInterval));
    document.getElementById('holdForward').addEventListener('mouseup', () => clearInterval(holdInterval));

    document.getElementById('playPause').addEventListener('click', () => {
        if (currentRate !== 0) {
            lastNonZeroRate = currentRate;
            smoothSetRate(0);
        } else {
            smoothSetRate(lastNonZeroRate || 1);
        }
    });

    setInterval(updateUI, 16);
</script>
</body>
</html>
